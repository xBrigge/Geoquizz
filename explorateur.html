<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Villes avec score Wikipedia - CSV réel</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { display: inline-block; margin: 5px 10px 5px 0; }
  input { margin-right: 10px; }
  #resultats p { margin: 5px 0; }
  .wikiScore { font-weight: bold; color: #1a73e8; }
</style>
</head>
<body>

<h2>Recherche de villes françaises</h2>
<label>Population min : <input type="number" id="popMin" value="10000" /></label>
<label>Distance max (km) : <input type="number" id="distMax" value="50" /></label>
<label>Code postal de départ : <input type="text" id="codePostal" value="75000" /></label>
<button id="btnChercher">Chercher</button>

<div id="resultats" style="margin-top:20px;">Résultats ici...</div>

<script>
// Distance Haversine en km
function distance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

// Charger CSV (requête fetch)
async function loadCSV(url) {
  const response = await fetch(url);
  if (!response.ok) throw new Error("Erreur chargement CSV");
  const text = await response.text();
  return text;
}

// Parser CSV simple (séparateur tabulation \t ici)
function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines[0].split('\t');

  return lines.slice(1).map(line => {
    const cols = line.split('\t');
    const obj = {};
    headers.forEach((h,i) => obj[h] = cols[i]);
    return obj;
  });
}

// Trouver coordonnées ville de départ par code postal (prend 1ère ville trouvée)
function findCoordByCodePostal(data, cp) {
  const ville = data.find(v => v.code_postal === cp || (v.codes_postaux && v.codes_postaux.includes(cp)));
  if (!ville) return null;
  return { lat: parseFloat(ville.latitude_mairie), lon: parseFloat(ville.longitude_mairie) };
}

async function getWikiExtractLength(wikiUrl) {
  try {
    if (!wikiUrl) return 0;
    const title = wikiUrl.split('/wiki/')[1];
    if (!title) return 0;
    const apiUrl = `https://fr.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts&explaintext=1&titles=${encodeURIComponent(title)}`;
    const response = await fetch(apiUrl);
    if (!response.ok) return 0;
    const data = await response.json();
    const pages = data.query.pages;
    const pageId = Object.keys(pages)[0];
    if (pageId === "-1") return 0;
    const extract = pages[pageId].extract || "";
    return extract.length;
  } catch (e) {
    console.warn("Erreur fetch wiki :", e);
    return 0;
  }
}

async function afficherVillesAvecScore(villes) {
  const maxVillesApi = 20;
  villes.forEach(v => v.wikiScore = 0);

  const container = document.getElementById("resultats");
  container.innerHTML = villes.map(v => `
    <p data-nom="${v.nom_standard}">
      <a href="${v.url_wikipedia}" target="_blank" rel="noopener noreferrer">${v.nom_standard} (${v.code_postal}) - ${Number(v.population).toLocaleString()} hab.</a>
      <span class="wikiScore" style="float:right;">⏳</span>
    </p>
  `).join("");

  const villesApi = villes.slice(0, maxVillesApi);
  await Promise.all(villesApi.map(async (ville) => {
    ville.wikiScore = await getWikiExtractLength(ville.url_wikipedia);
  }));

  villes.sort((a,b) => b.wikiScore - a.wikiScore);

  container.innerHTML = villes.map(v => `
    <p>
      <a href="${v.url_wikipedia}" target="_blank" rel="noopener noreferrer">${v.nom_standard} (${v.code_postal}) - ${Number(v.population).toLocaleString()} hab.</a>
      <span class="wikiScore" style="float:right;">Score: ${(v.wikiScore/1000).toFixed(1)}</span>
    </p>
  `).join("");
}

document.getElementById("btnChercher").addEventListener("click", async () => {
  const popMin = parseInt(document.getElementById("popMin").value) || 0;
  const distMax = parseFloat(document.getElementById("distMax").value) || 9999;
  const codePostal = document.getElementById("codePostal").value.trim();

  document.getElementById("resultats").innerText = "Chargement du fichier CSV...";
  let data;
  try {
    const csvText = await loadCSV("villes.csv");
    data = parseCSV(csvText);
  } catch (e) {
    document.getElementById("resultats").innerText = "Erreur chargement du fichier CSV.";
    return;
  }

  const coord = findCoordByCodePostal(data, codePostal);
  if (!coord) {
    document.getElementById("resultats").innerText = "Code postal de départ introuvable.";
    return;
  }

  // Filtrer villes selon population & distance
  const villesFiltree = data.filter(v => {
    const pop = Number(v.population) || 0;
    const lat = parseFloat(v.latitude_mairie);
    const lon = parseFloat(v.longitude_mairie);
    if (isNaN(lat) || isNaN(lon)) return false;
    if (pop < popMin) return false;
    const dist = distance(coord.lat, coord.lon, lat, lon);
    return dist <= distMax;
  });

  if (villesFiltree.length === 0) {
    document.getElementById("resultats").innerText = "Aucune ville trouvée avec ces critères.";
    return;
  }

  await afficherVillesAvecScore(villesFiltree);
});
</script>

</body>
</html>
