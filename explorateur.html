<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Recherche villes françaises par distance</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    a { color: #0066cc; text-decoration: none; }
    a:hover { text-decoration: underline; }
    label { display: block; margin-top: 15px; }
    input[type="text"], input[type="number"] { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 20px; }
    #resultats p { margin: 7px 0; }
  </style>
</head>
<body>

<h1>Recherche de villes autour d’un code postal</h1>

<form id="formRecherche">
  <label>
    Code postal (ex: 75000) :
    <input type="text" id="inputCodePostal" required pattern="\d{5}" title="5 chiffres requis"/>
  </label>
  <label>
    Distance min en km (ex: 0) :
    <input type="number" id="inputDistanceMin" value="0" min="0" />
  </label>
  <label>
    Distance max en km (ex: 50) :
    <input type="number" id="inputDistance" value="50" min="1" required />
  </label>
  <label>
    Population min (ex: 10000) :
    <input type="number" id="inputPopulationMin" value="10000" min="0" />
  </label>
  <label>
    Population max (ex: 200000) :
    <input type="number" id="inputPopulationMax" min="0" />
  </label>
  <button type="submit">Rechercher</button>
</form>

<div id="resultats">Chargement des données...</div>

<script>
  let villes = [];

  // Fonction de calcul de distance (Haversine)
  function haversineDistance(lat1, lon1, lat2, lon2) {
    const toRad = angle => angle * Math.PI / 180;
    const R = 6371; // km
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  // Chargement du CSV
  Papa.parse("villes.csv", {
    download: true,
    header: true,
    complete: function(results) {
      villes = results.data
        .filter(v => v.population && Number(v.population) >= 1)
        .map(v => ({
          nom: v.nom_standard,
          code_postal: v.code_postal,
          population: Number(v.population),
          latitude: Number(v.latitude_mairie),
          longitude: Number(v.longitude_mairie),
          url: v.url_wikipedia || "#"
        }));

      document.getElementById("resultats").innerHTML = "<p>Prêt, entre un code postal et tes critères.</p>";
    },
    error: function(err) {
      document.getElementById("resultats").innerHTML = `<p>Erreur lors du chargement du fichier CSV : ${err.message}</p>`;
    }
  });

  // Recherche sur formulaire
  document.getElementById("formRecherche").addEventListener("submit", e => {
    e.preventDefault();

    const codePostalRecherche = document.getElementById("inputCodePostal").value.trim();
    const distMin = Number(document.getElementById("inputDistanceMin").value) || 0;
    const distMax = Number(document.getElementById("inputDistance").value);
    const popMin = Number(document.getElementById("inputPopulationMin").value) || 0;
    const popMaxInput = document.getElementById("inputPopulationMax").value.trim();
    const popMax = popMaxInput === "" ? Infinity : Number(popMaxInput);

    if (distMin > distMax) {
      alert("La distance min ne peut pas être supérieure à la distance max.");
      return;
    }
    if (popMin > popMax) {
      alert("La population min ne peut pas être supérieure à la population max.");
      return;
    }

    const villeCentre = villes.find(v => v.code_postal === codePostalRecherche);

    if (!villeCentre) {
      document.getElementById("resultats").innerHTML = `<p>Code postal introuvable dans la base.</p>`;
      return;
    }

    const villesTrouvees = villes.filter(v => {
      if (v.population < popMin || v.population > popMax) return false;
      const dist = haversineDistance(
        villeCentre.latitude, villeCentre.longitude,
        v.latitude, v.longitude
      );
      return dist >= distMin && dist <= distMax;
    });

    if (villesTrouvees.length === 0) {
      document.getElementById("resultats").innerHTML = `<p>Aucune ville trouvée répondant aux critères.</p>`;
      return;
    }

    const html = villesTrouvees
      .sort((a, b) => b.population - a.population)
      .map(v => `
        <p>
          <a href="${v.url}" target="_blank" rel="noopener noreferrer">
            ${v.nom} (${v.code_postal}) - ${v.population.toLocaleString()} hab.
          </a>
        </p>
      `).join("");

    document.getElementById("resultats").innerHTML = html;
  });
</script>

</body>
</html>
